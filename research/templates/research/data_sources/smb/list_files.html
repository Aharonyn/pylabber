{% extends 'base.html' %} 

{% block content %}

    <h4>
        Remote Resources
    </h4>

    <hr>

    <input id="searchInput" type="text" name="searchInput"><br>

    <a href="{% url 'smb:create' %}"><button class="btn btn-sm">Add</button></a>

    <a id="syncLink" href="#"><button id="syncButton" class="btn btn-sm" disabled >Sync</button></a>

    <div id="treeView" class="col-6"></div>



{% endblock content %}

{% block extra-scripts %} 
    <script>
        $(function() {
            // Create lazy loading tree
            $('#treeView').jstree({
                'core' : {
                    'data' : {
                        "url" : "{% url 'smb:lazy_json' %}",
                        "data" : function (node) {
                            return { "id" : node.id };
                        }
                    }
                },
                "plugins" : [ "wholerow", "state", "sort", "search", "contextmenu" ],
                "check_callback" : true,
                "contextmenu": {         
                    "items": function($node) {
                        return {
                            "Sync Children": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Sync Children",
                                "action": function (obj) { 
                                    var id = $('#treeView').jstree("get_selected");
                                    $.ajax(
                                        {
                                            type: "GET",
                                            url: "{% url 'smb:sync_ajax' %}",
                                            data: {
                                                "path_id": id
                                            },
                                            success: function (data) {
                                                console.log(data)
                                            }
                                        }
                                    )
                                }
                            },
                            "Sync Descendants": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "Sync Descendants",
                                "action": function (obj) { 
                                    tree.edit($node);
                                }
                            }
                        };
                    }
                }

            // Disable sync button if nothing selected
            }).on('changed.jstree', function (e, data) {
                    if (data.selected.length > 0) {
                        $('#syncButton').prop('disabled', false);
                    } else {
                        $('#syncButton').prop('disabled', true);
                    }
                });
            var to = false;
            $('#searchInput').keyup(function () {
                if(to) { clearTimeout(to); }
                to = setTimeout(function () {
                    var v = $('#searchInput').val();
                    $('#treeView').jstree(true).search(v);
                }, 250);
            });
        });
    </script>
{% endblock extra-scripts %}
